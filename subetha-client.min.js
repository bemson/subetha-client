/* SubEtha-Client v0.0.0-alpha + Morus v1.0.0 | github.com/bemson | (c) 2014, APACHE & MIT */
!function(u,v,q,I){function n(){function q(){for(var r={},g=d.concat(),m,f,w,n=95;n--;)w=v(y()*n),f=n+32,m=g[w],r[f+"c"]=m,r[m]=f,g.splice(w,1);return r}function t(){this.randomize()}var n={},d=[],u,x=JSON.stringify,z=JSON.parse,y=Math.random,v=Math.round,s=/[ -~]/g,D=/^(\d+)({.+})$/;!function(){for(var r=95,g,m;r--;)g=r+32,m=String.fromCharCode(g),n[g+"c"]=d[r]=m,n[m]=g;u=d.join("")}();t.prototype.encode=function(d){var g=this.key,m=this.index,f;return d.replace(s,function(d){f=n[d];f-=32-m;f%=95;
f+=32;m++;return g[f+"c"]})};t.prototype.decode=function(d){var g=this.key,m=this.index,f;return d.replace(s,function(d){f=g[d];f-=32+m;0>f&&(f%=95)&&(f=95+f);f+=32;m++;return n[f+"c"]})};t.prototype.randomize=function(){this.key=q();this.index=v(95*y());return this};t.prototype.cipher=function(d){var g;return arguments.length?"string"==typeof d&&(g=D.exec(d))?(this.index=+g[1],this.key=z(g[2]),!0):!1:this.index+x(this.key)};t.genKey=q;t.ASCII=u;return t}u?define(n):v?module.exports=n():q.Morus||
(q.Morus=n())}("function"==typeof define,"undefined"!=typeof exports,this);
!function(u,v,q,I,n,S,t,ia,d,ja){function x(){function z(a){for(var b=1,c,e;c=arguments[b];b++)for(e in c)l.call(c,e)&&(a[e]=c[e]);return a}function y(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(ba,x)}function x(a){var b=16*U()|0;return("x"===a?b:b&3|8).toString(16)}function s(a){return a&&"string"===typeof a}function D(){E.contains(p)&&E.removeChild(p)}function r(a){var b=a.data,c,e,h,N;if(!V&&"string"===typeof b&&"[]"===b.charAt(0)+b.charAt(b.length-1))try{b=W(b)}catch(f){return}O(b)&&
"se-0"==b[0]&&3===b.length&&l.call(A,b[1])&&0<(e=(c=A[b[1]]).state)&&4>e&&(h=c.decode(b[2]))&&s(h.mid)&&l.call(h,"sent")&&l.call(h,"msg")&&l.call(X,N=h.type)&&(h.sent=new I(h.sent),X[N](c,h.msg,h,a))}function g(){var a=J,b;E=K.body;F(d,"DOMContentLoaded",g);F(d,"load",g);P=function(a){var b=a.url;(l.call(A,b)?A[b]:A[b]=new T(b)).addClient(a)};Y=function(a){var b=a._bridge(Q);b&&b.removeClient(a)};J=0;for(b in a)l.call(a,b)&&P(a[b])}function m(a,b,c,e,h,N,f,k){var d;l.call(a,b)&&l.call((d=a[b]).peers,
c)&&(a=d.peers[c],e(d,a,h,{id:f.mid,peer:a,sent:new I(f.sent),timeStamp:k.timeStamp}))}function f(a,b){var c=a.state;b!==c&&(a.state=b,a.fire("::readyStateChange",b,c),a.state===b&&(0===b&&(a.peers={},2<c&&a.fire("::disconnect")),3===b&&a.fire("::connect")))}function w(){}function T(a){var b=this,c=K.createElement("iframe"),e=new ca;b.iframe=c;b.id=a;b.cipher=e;b.clients={};b.channels={};b.channelCnts={};b.ping=["se-0",Z,a,e.cipher()].join("`");$++||(G(d,"message",r),G(d,"unload",D));b.onLoad=function(){3>
b.state?(b.iframe.contentWindow.postMessage(b.ping,"*"),b.state=2):b.destroy()};G(c,"load",b.onLoad);l.call(H.urls,a)?c.src=H.urls[a]:c.src=a;b.dDay(H.bridgeTimeout);p.appendChild(c);b.inDom()||E.appendChild(p)}function L(){this.peers={};this.credentials=[]}function M(a,b){this._client=b;a&&(this.id=a.id,this.origin=a.origin,this.start=new I(a.start),this.channel=a.channel)}var ca=v||u?require("morus"):d.Morus,da=S.stringify,W=S.parse,U=n.random,l=t.prototype.hasOwnProperty,aa=q.prototype.slice,K=
document,E,ba=/[xy]/g,Z=U(),C={},ea=/^([\w\-]+\.)+[conmi]\w{1,2}\b/,fa=/^[^{]{0,40}({.+})[^}]{0,40}$/,R="f"==location.protocol.charAt(0),ga=R?"http://":"//",p=K.createElement("div"),A={},$=0,J={},Q={},P=function(a){J[a.id]=a},Y=function(a){delete J[a.id];f(a,0)},V=!!function(){var a=1;try{d.postMessage({toString:function(){a=0}},"*")}catch(b){}return a}(),ha=V?function(a,b){a.postMessage(b,"*")}:function(a,b){a.postMessage(da(b),"*")},G=d.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:function(a,
b,c){a.addEventListener(b,c,!1)},F=d.attachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(a,b,c){a.removeEventListener(b,c,!1)},O="function"===typeof q.isArray?q.isArray:function(a){return a instanceof q},X={ready:function(a,b){var c=a.clients,e;a.dDay();a.origin=b;a.state=3;for(e in c)l.call(c,e)&&a.auth(c[e])},auth:function(a,b){var c=a.channels,e=a.clients,h=b.id,d,g,k,B;if(l.call(e,h))if(e=e[h],k=b.peers,b.ok&&2===e.state){g=e.peers={};for(B in k)if(l.call(k,B)){d=1;var m=k[B];e.peers[m.id]=
new M(m,e)}k=e.channel;l.call(c,k)||(c[k]={},a.channelCnts[k]=0);c[k][h]=e;a.channelCnts[k]++;f(e,3);if(d&&3===e.state)for(B in g)l.call(g,B)&&e.fire("::join",g[B],!0)}else a.remove(e)},net:function(a,b){var c,e,h,d=b.joins,f=b.drops,k,g,m,n;for(m=d.length;m--;){k=d[m];g=k.id;c=a.channels[k.channel];n=[];for(e in c)e!=g&&l.call(c,e)&&!l.call((h=c[e]).peers,g)&&(h.peers[k.id]=new M(k,h),n.push(h));for(c=n.length;c--;)h=n[c],h.fire("::join",h.peers[g])}for(m=f.length;m--;){d=[];k=f[m];g=k.id;c=a.channels[k.channel];
for(e in c)e!=g&&l.call(c,e)&&(h=c[e],k=h.peers[g],d.push([h,k]),k.state=0,delete h.peers[g]);for(c=d.length;c--;)h=d[c][0],h.id!=g&&h.fire("::drop",d[c][1])}},die:function(a){a.deref();a.destroy()},client:function(a,b,c,e){a=a.clients;var h=b.from,d=H.msgType,f,k,g;if("object"===typeof d&&l.call(d,b.type))if(d=d[b.type],g=b.to,f=b.data,g)for(k=g.length;k--;)m(a,g[k],h,d,f,b,c,e);else for(k in a)l.call(a,k)&&m(a,k,h,d,f,b,c,e)}},H={bridgeTimeout:1E4,guid:y,Client:L,Peer:M,EventEmitter:w,protocol:"se-0",
urls:{"public":(R?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/public_bridge.html",local:"javascript:'<script src=\""+(R?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/subetha-bridge.min.js\">\x3c/script>'"},msgType:{}};C["::drop"]=1;C["::join"]=1;C["::readyStateChange"]=1;C["::connect"]=1;C["::disconnect"]=1;p.style.display="none";p.setAttribute("aria-hidden","true");p.setAttribute("hidden","hidden");p.setAttribute("data-owner","subetha");z(w.prototype,{on:function(a,b){s(a)&&"function"===
typeof b&&(l.call(this,"_evts")||(this._evts={}),l.call(this._evts,a)||(this._evts[a]=[]),this._evts[a].push(b));return this},off:function(a,b){var c,e,h=arguments.length;if(!l.call(this,"_evts")||!h)this._evts={};else if(s(a)&&l.call(this._evts,a)){c=this._evts[a];if("function"==typeof b)for(e=c.length;e--;)if(c[e]===b){c.splice(e,1);break}(2>h||!c.length)&&delete this._evts[a]}return this},fire:function(a){var b=this,c,e,h,d,f;if(s(a)&&l.call(b,"_evts")&&l.call(b._evts,a)&&(h=(e=b._evts[a]).length))for(c=
aa.call(arguments,1),f=c.length?function(a){a.apply(b,c)}:function(a){a.call(b)},d=0;d<h;d++)f(e[d]);return b}});z(T.prototype,{failures:0,state:1,cnt:0,addClient:function(a){var b=this,c=b.clients,e=a.id;l.call(c,e)||(b.cnt++,a._bridge=function(a){return a===Q&&b},c[e]=a);3==b.state&&b.auth(a)},removeClient:function(a){var b=a.id,c=a.channel;--this.cnt?(delete this.clients[b],1<a.state&&(delete this.channels[c][b],1==this.channelCnts[c]--&&delete this.channelCnts[c]),this.drop(a)):this.destroy()},
auth:function(a){var b;f(a,2);2==a.state&&(b=a.credentials,O(b)||(b=[b]),this.send("auth",{id:a.id,channel:a.channel,creds:b}))},destroy:function(){var a=this.state,b=this.iframe,c=this.clients,e;this.dDay();this.state=4;this.clients={};this.cnt=0;for(e in c)l.call(c,e)&&this.drop(c[e]);this.cnt?this.state=a:(this.deref(),F(b,"load",this.onLoad),--$||(F(d,"message",r),F(d,"unload",D),D()),p.contains(b)&&p.removeChild(b))},deref:function(){delete A[this.id]},drop:function(a){var b=a.state;delete a._bridge;
1<b&&4>b&&(this.send("drop",a.id),3==b&&f(a,4));a.peers={};4==a.state&&f(a,0)},decode:function(a){var b=this.cipher,c;if(s(a)&&(c=b.decode(a))&&(c=fa.exec(c)))try{return c=W(c[1]),b.shift++,c}catch(e){}3===++this.failures&&this.destroy();return 0},inDom:function(){var a=this.iframe;return p.contains(a)&&E.contains(a)},dDay:function(a){var b=this;clearTimeout(b.timer);a&&(b.timer=setTimeout(function(){b.destroy()},a))},send:function(a,b){var c;if(3!=this.state)return 0;c=y();ha(this.iframe.contentWindow,
{key:Z,mid:c,type:a,msg:b});return c}});L.prototype=new w;z(L.prototype,{id:"",channel:"lobby",url:"local",state:0,_bridge:function(){return!1},open:function(a){var b=this.channel,c=this.url,e=arguments,d=this.state,g;s(a)&&(g=a.indexOf("@"),~g?(b=a.substring(0,g)||b,c=a.substring(g+1)||c):b=a,1<e.length&&(this.credentials=aa.call(e,1)));ea.test(c)&&(c=ga+c);if(2<d){if(b==this.channel&&c==this.url)return;this.close()}this.channel=b;this.url=c;2>d&&(this.id=y(),f(this,1),1==this.state&&P(this));return this},
close:function(){var a=this.state;0<a&&4>a&&Y(this);return this},_transmit:function(a,b,c){var e=this._bridge(Q),d;if((d=e&&3==e.state&&3==this.state&&s(a)&&!l.call(C,a))&&!(d=!b)){a:{d=this.peers;var g=[],f,k;O(b)||(b=[b]);for(k=b.length;k--;){f=b[k];f instanceof Subetha.Peer&&(f=f.id);if(!l.call(d,f)){d=0;break a}g.push(f)}d=g}d=b=d}return d?e.send("client",{type:a,from:this.id,to:b?[].concat(b):0,data:c}):!1}});z(M.prototype,{state:3});"function"!==typeof d.postMessage?L.prototype.open=function(){return this}:
K.body?g():(G(d,"DOMContentLoaded",g),G(d,"load",g));return H}u?define(x):v?module.exports=x():d.Subetha||(d.Subetha=x())}("function"===typeof define,"undefined"!=typeof exports,Array,Date,Math,JSON,Object,RegExp,this);