/* SubEtha-Client v0.0.1-alpha + Morus v1.0.0 | github.com/bemson | (c) 2014, APACHE & MIT */
!function(v,w,q,J){function n(){function q(){for(var r={},g=d.concat(),m,f,x,n=95;n--;)x=w(z()*n),f=n+32,m=g[x],r[f+"c"]=m,r[m]=f,g.splice(x,1);return r}function u(){this.randomize()}var n={},d=[],v,y=JSON.stringify,A=JSON.parse,z=Math.random,w=Math.round,t=/[ -~]/g,E=/^(\d+)({.+})$/;!function(){for(var r=95,g,m;r--;)g=r+32,m=String.fromCharCode(g),n[g+"c"]=d[r]=m,n[m]=g;v=d.join("")}();u.prototype.encode=function(d){var g=this.key,m=this.index,f;return d.replace(t,function(d){f=n[d];f-=32-m;f%=95;
f+=32;m++;return g[f+"c"]})};u.prototype.decode=function(d){var g=this.key,m=this.index,f;return d.replace(t,function(d){f=g[d];f-=32+m;0>f&&(f%=95)&&(f=95+f);f+=32;m++;return n[f+"c"]})};u.prototype.randomize=function(){this.key=q();this.index=w(95*z());return this};u.prototype.cipher=function(d){var g;return arguments.length?"string"==typeof d&&(g=E.exec(d))?(this.index=+g[1],this.key=A(g[2]),!0):!1:this.index+y(this.key)};u.genKey=q;u.ASCII=v;return u}v?define(n):w?module.exports=n():q.Morus||
(q.Morus=n())}("function"==typeof define,"undefined"!=typeof exports,this);
!function(v,w,q,J,n,T,u,ka,d,la){function y(){function A(a){for(var b=1,c,e;c=arguments[b];b++)for(e in c)l.call(c,e)&&(a[e]=c[e]);return a}function z(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(da,y)}function y(a){var b=16*V()|0;return("x"===a?b:b&3|8).toString(16)}function t(a){return a&&"string"===typeof a}function E(){F.contains(p)&&F.removeChild(p)}function r(a){var b=a.data,c,e,h,O;if(!W&&"string"===typeof b&&"[]"===b.charAt(0)+b.charAt(b.length-1))try{b=X(b)}catch(f){return}P(b)&&
"se-0"==b[0]&&3===b.length&&l.call(B,b[1])&&0<(e=(c=B[b[1]]).state)&&4>e&&(h=c.decode(b[2]))&&t(h.mid)&&l.call(h,"sent")&&l.call(h,"msg")&&l.call(Y,O=h.type)&&(h.sent=new J(h.sent),Y[O](c,h.msg,h,a))}function g(){var a=K,b;F=L.body;G(d,"DOMContentLoaded",g);G(d,"load",g);Q=function(a){var b=a.url;(l.call(B,b)?B[b]:B[b]=new U(b)).addClient(a)};Z=function(a){var b=a._bridge(R);b&&b.removeClient(a)};K=0;for(b in a)l.call(a,b)&&Q(a[b])}function m(a,b,c,e,h,O,f,k){var d;l.call(a,b)&&l.call((d=a[b]).peers,
c)&&(a=d.peers[c],e(d,a,h,{id:f.mid,peer:a,sent:new J(f.sent),timeStamp:k.timeStamp}))}function f(a,b){var c=a.state;b!==c&&(a.state=b,a.fire("::readyStateChange",b,c),a.state===b&&(0===b&&(a.peers={},2<c&&a.fire("::disconnect")),3===b&&a.fire("::connect")))}function x(){}function U(a){var b=this,c=L.createElement("iframe"),e=new ea;b.iframe=c;b.id=a;b.cipher=e;b.clients={};b.channels={};b.channelCnts={};b.ping=["se-0",aa,a,e.cipher()].join("`");ba++||(H(d,"message",r),H(d,"unload",E));b.onLoad=function(){3>
b.state?(b.iframe.contentWindow.postMessage(b.ping,"*"),b.state=2):b.destroy()};H(c,"load",b.onLoad);l.call(I.urls,a)?c.src=I.urls[a]:c.src=a;b.dDay(I.bridgeTimeout);p.appendChild(c);b.inDom()||F.appendChild(p)}function M(){this.peers={};this.credentials=[]}function N(a,b){this._client=b;a&&(this.id=a.id,this.origin=a.origin,this.start=new J(a.start),this.channel=a.channel)}var ea=w||v?require("morus"):d.Morus,fa=T.stringify,X=T.parse,V=n.random,l=u.prototype.hasOwnProperty,ca=q.prototype.slice,L=
document,F,da=/[xy]/g,aa=V(),D={},ga=/^([\w\-]+\.)+[conmi]\w{1,2}\b/,ha=/^[^{]{0,40}({.+})[^}]{0,40}$/,S="f"==location.protocol.charAt(0),ia=S?"http://":"//",p=L.createElement("div"),B={},ba=0,K={},R={},Q=function(a){K[a.id]=a},Z=function(a){delete K[a.id];f(a,0)},W=!!function(){var a=1;try{d.postMessage({toString:function(){a=0}},"*")}catch(b){a=0}return a}(),ja=W?function(a,b){a.postMessage(b,"*")}:function(a,b){a.postMessage(fa(b),"*")},H=d.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:
function(a,b,c){a.addEventListener(b,c,!1)},G=d.attachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(a,b,c){a.removeEventListener(b,c,!1)},P="function"===typeof q.isArray?q.isArray:function(a){return a instanceof q},Y={ready:function(a,b){var c=a.clients,e;a.dDay();a.origin=b;a.state=3;for(e in c)l.call(c,e)&&a.auth(c[e])},auth:function(a,b){var c=a.channels,e=a.clients,h=b.id,d,g,k,C;if(l.call(e,h))if(e=e[h],k=b.peers,b.ok&&2===e.state){g=e.peers={};for(C in k)if(l.call(k,C)){d=1;var m=
k[C];e.peers[m.id]=new N(m,e)}k=e.channel;l.call(c,k)||(c[k]={},a.channelCnts[k]=0);c[k][h]=e;a.channelCnts[k]++;f(e,3);if(d&&3===e.state)for(C in g)l.call(g,C)&&e.fire("::join",g[C],!0)}else a.remove(e)},net:function(a,b){var c,e,h,d=b.joins,f=b.drops,k,g,m,n;for(m=d.length;m--;){k=d[m];g=k.id;c=a.channels[k.channel];n=[];for(e in c)e!=g&&l.call(c,e)&&!l.call((h=c[e]).peers,g)&&(h.peers[k.id]=new N(k,h),n.push(h));for(c=n.length;c--;)h=n[c],h.fire("::join",h.peers[g])}for(m=f.length;m--;){d=[];k=
f[m];g=k.id;c=a.channels[k.channel];for(e in c)e!=g&&l.call(c,e)&&(h=c[e],k=h.peers[g],d.push([h,k]),k.state=0,delete h.peers[g]);for(c=d.length;c--;)h=d[c][0],h.id!=g&&h.fire("::drop",d[c][1])}},die:function(a){a.deref();a.destroy()},client:function(a,b,c,e){a=a.clients;var h=b.from,d=I.msgType,f,k,g;if("object"===typeof d&&l.call(d,b.type))if(d=d[b.type],g=b.to,f=b.data,g)for(k=g.length;k--;)m(a,g[k],h,d,f,b,c,e);else for(k in a)l.call(a,k)&&m(a,k,h,d,f,b,c,e)}},I={bridgeTimeout:1E4,guid:z,Client:M,
Peer:N,EventEmitter:x,protocol:"se-0",urls:{"public":(S?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/public_bridge.html",local:"javascript:'<script src=\""+(S?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/subetha-bridge.min.js\">\x3c/script>'"},msgType:{}};D["::drop"]=1;D["::join"]=1;D["::readyStateChange"]=1;D["::connect"]=1;D["::disconnect"]=1;p.style.display="none";p.setAttribute("aria-hidden","true");p.setAttribute("hidden","hidden");p.setAttribute("data-owner","subetha");A(x.prototype,
{on:function(a,b){t(a)&&"function"===typeof b&&(l.call(this,"_evts")||(this._evts={}),l.call(this._evts,a)||(this._evts[a]=[]),this._evts[a].push(b));return this},off:function(a,b){var c,e,h=arguments.length;if(!l.call(this,"_evts")||!h)this._evts={};else if(t(a)&&l.call(this._evts,a)){c=this._evts[a];if("function"==typeof b)for(e=c.length;e--;)if(c[e]===b){c.splice(e,1);break}(2>h||!c.length)&&delete this._evts[a]}return this},fire:function(a){var b=this,c,e,h,d,f;if(t(a)&&l.call(b,"_evts")&&l.call(b._evts,
a)&&(h=(e=b._evts[a]).length))for(c=ca.call(arguments,1),f=c.length?function(a){a.apply(b,c)}:function(a){a.call(b)},d=0;d<h;d++)f(e[d]);return b}});A(U.prototype,{failures:0,state:1,cnt:0,addClient:function(a){var b=this,c=b.clients,e=a.id;l.call(c,e)||(b.cnt++,a._bridge=function(a){return a===R&&b},c[e]=a);3==b.state&&b.auth(a)},removeClient:function(a){var b=a.id,c=a.channel;--this.cnt?(delete this.clients[b],1<a.state&&(delete this.channels[c][b],1==this.channelCnts[c]--&&delete this.channelCnts[c]),
this.drop(a)):this.destroy()},auth:function(a){var b;f(a,2);2==a.state&&(b=a.credentials,P(b)||(b=[b]),this.send("auth",{id:a.id,channel:a.channel,creds:b}))},destroy:function(){var a=this.state,b=this.iframe,c=this.clients,e;this.dDay();this.state=4;this.clients={};this.cnt=0;for(e in c)l.call(c,e)&&this.drop(c[e]);this.cnt?this.state=a:(this.deref(),G(b,"load",this.onLoad),--ba||(G(d,"message",r),G(d,"unload",E),E()),p.contains(b)&&p.removeChild(b))},deref:function(){delete B[this.id]},drop:function(a){var b=
a.state;delete a._bridge;1<b&&4>b&&(this.send("drop",a.id),3==b&&f(a,4));a.peers={};4==a.state&&f(a,0)},decode:function(a){var b=this.cipher,c;if(t(a)&&(c=b.decode(a))&&(c=ha.exec(c)))try{return c=X(c[1]),b.shift++,c}catch(e){}3===++this.failures&&this.destroy();return 0},inDom:function(){var a=this.iframe;return p.contains(a)&&F.contains(a)},dDay:function(a){var b=this;clearTimeout(b.timer);a&&(b.timer=setTimeout(function(){b.destroy()},a))},send:function(a,b){var c;if(3!=this.state)return 0;c=z();
ja(this.iframe.contentWindow,{key:aa,mid:c,type:a,msg:b});return c}});M.prototype=new x;A(M.prototype,{id:"",channel:"lobby",url:"local",state:0,_bridge:function(){return!1},open:function(a){var b=this.channel,c=this.url,e=arguments,d=this.state,g;t(a)&&(g=a.indexOf("@"),~g?(b=a.substring(0,g)||b,c=a.substring(g+1)||c):b=a,1<e.length&&(this.credentials=ca.call(e,1)));ga.test(c)&&(c=ia+c);if(2<d){if(b==this.channel&&c==this.url)return;this.close();d=this.state}this.channel=b;this.url=c;2>d&&(this.id=
z(),f(this,1),1==this.state&&Q(this));return this},close:function(){var a=this.state;0<a&&4>a&&Z(this);return this},_transmit:function(a,b,c){var e=this._bridge(R),d;if((d=e&&3==e.state&&3==this.state&&t(a)&&!l.call(D,a))&&!(d=!b)){a:{d=this.peers;var g=[],f,k;P(b)||(b=[b]);for(k=b.length;k--;){f=b[k];f instanceof Subetha.Peer&&(f=f.id);if(!l.call(d,f)){d=0;break a}g.push(f)}d=g}d=b=d}return d?e.send("client",{type:a,from:this.id,to:b?[].concat(b):0,data:c}):!1}});A(N.prototype,{state:3});"function"!==
typeof d.postMessage?M.prototype.open=function(){return this}:L.body?g():(H(d,"DOMContentLoaded",g),H(d,"load",g));return I}v?define(y):w?module.exports=y():d.Subetha||(d.Subetha=y())}("function"===typeof define,"undefined"!=typeof exports,Array,Date,Math,JSON,Object,RegExp,this);