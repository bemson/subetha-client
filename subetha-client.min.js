/* SubEtha-Client v0.0.1-alpha + Morus v1.0.0 | github.com/bemson | (c) 2014, APACHE & MIT */
!function(N,O,A,G,ba,P,ca,la,f,ma){function p(){function B(a){for(var b=1,c,d;c=arguments[b];b++)for(d in c)k.call(c,d)&&(a[d]=c[d]);return a}function p(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(da,ea)}function ea(a){var b=16*Q()|0;return("x"===a?b:b&3|8).toString(16)}function q(a){return a&&"string"===typeof a}function H(){v.contains(m)&&v.removeChild(m)}function R(a){var b=a.data,c,d,e,h;if(!S&&"string"===typeof b&&"[]"===b.charAt(0)+b.charAt(b.length-1))try{b=T(b)}catch(n){return}I(b)&&
"se-0"==b[0]&&3===b.length&&k.call(r,b[1])&&0<(d=(c=r[b[1]]).state)&&4>d&&(e=c.decode(b[2]))&&q(e.mid)&&k.call(e,"sent")&&k.call(e,"msg")&&k.call(U,h=e.type)&&(e.sent=new G(e.sent),U[h](c,e.msg,e,a))}function w(){var a=C,b;v=D.body;x(f,"DOMContentLoaded",w);x(f,"load",w);J=function(a){var b=a.url;(k.call(r,b)?r[b]:r[b]=new V(b)).addClient(a)};W=function(a){var b=a._bridge(K);b&&b.removeClient(a)};C=0;for(b in a)k.call(a,b)&&J(a[b])}function X(a,b,c,d,e,h,n,g){var l;k.call(a,b)&&k.call((l=a[b]).peers,
c)&&(a=l.peers[c],d(l,a,e,{id:n.mid,peer:a,sent:new G(n.sent),timeStamp:g.timeStamp}))}function t(a,b){var c=a.state;b!==c&&(a.state=b,a.fire("::readyStateChange",b,c),a.state===b&&(0===b&&(a.peers={},2<c&&a.fire("::disconnect")),3===b&&a.fire("::connect")))}function L(){}function V(a){var b=this,c=D.createElement("iframe"),d=new fa;c.setAttribute("sandbox","allow-same-origin allow-scripts");b.iframe=c;b.id=a;b.cipher=d;b.clients={};b.channels={};b.channelCnts={};b.ping=["se-0",Y,a,d.cipher()].join("`");
Z++||(y(f,"message",R),y(f,"unload",H));b.onLoad=function(){3>b.state?(b.iframe.contentWindow.postMessage(b.ping,"*"),b.state=2):b.destroy()};y(c,"load",b.onLoad);k.call(z.urls,a)?c.src=z.urls[a]:c.src=a;b.dDay(z.bridgeTimeout);m.appendChild(c);b.inDom()||v.appendChild(m)}function E(){this.peers={};this.credentials=[]}function F(a,b){this._client=b;a&&(this.id=a.id,this.origin=a.origin,this.start=new G(a.start),this.channel=a.channel)}var fa=O||N?require("morus"):f.Morus,ga=P.stringify,T=P.parse,
Q=ba.random,k=ca.prototype.hasOwnProperty,aa=A.prototype.slice,D=document,v,da=/[xy]/g,Y=Q(),u={},ha=/^([\w\-]+\.)+[conmi]\w{1,2}\b/,ia=/^[^{]{0,40}({.+})[^}]{0,40}$/,M="f"==location.protocol.charAt(0),ja=M?"http://":"//",m=D.createElement("div"),r={},Z=0,C={},K={},J=function(a){C[a.id]=a},W=function(a){delete C[a.id];t(a,0)},S=!!function(){var a=1;try{f.postMessage({toString:function(){a=0}},"*")}catch(b){}return a}(),ka=S?function(a,b){a.postMessage(b,"*")}:function(a,b){a.postMessage(ga(b),"*")},
y=f.attachEvent?function(a,b,c){a.attachEvent("on"+b,c)}:function(a,b,c){a.addEventListener(b,c,!1)},x=f.attachEvent?function(a,b,c){a.detachEvent("on"+b,c)}:function(a,b,c){a.removeEventListener(b,c,!1)},I="function"===typeof A.isArray?A.isArray:function(a){return a instanceof A},U={ready:function(a,b){var c=a.clients,d;a.dDay();a.origin=b;a.state=3;for(d in c)k.call(c,d)&&a.auth(c[d])},auth:function(a,b){var c=a.channels,d=a.clients,e=b.id,h,n,g,l;if(k.call(d,e))if(d=d[e],g=b.peers,b.ok&&2===d.state){n=
d.peers={};for(l in g)if(k.call(g,l)){h=1;var f=g[l];d.peers[f.id]=new F(f,d)}g=d.channel;k.call(c,g)||(c[g]={},a.channelCnts[g]=0);c[g][e]=d;a.channelCnts[g]++;t(d,3);if(h&&3===d.state)for(l in n)k.call(n,l)&&d.fire("::join",n[l],!0)}else a.remove(d)},net:function(a,b){var c,d,e,h=b.joins,n=b.drops,g,l,f,m;for(f=h.length;f--;){g=h[f];l=g.id;c=a.channels[g.channel];m=[];for(d in c)d!=l&&k.call(c,d)&&!k.call((e=c[d]).peers,l)&&(e.peers[g.id]=new F(g,e),m.push(e));for(c=m.length;c--;)e=m[c],e.fire("::join",
e.peers[l])}for(f=n.length;f--;){h=[];g=n[f];l=g.id;c=a.channels[g.channel];for(d in c)d!=l&&k.call(c,d)&&(e=c[d],g=e.peers[l],h.push([e,g]),g.state=0,delete e.peers[l]);for(c=h.length;c--;)e=h[c][0],e.id!=l&&e.fire("::drop",h[c][1])}},die:function(a){a.deref();a.destroy()},client:function(a,b,c,d){a=a.clients;var e=b.from,h=z.msgType,f,g,l;if("object"===typeof h&&k.call(h,b.type))if(h=h[b.type],l=b.to,f=b.data,l)for(g=l.length;g--;)X(a,l[g],e,h,f,b,c,d);else for(g in a)k.call(a,g)&&X(a,g,e,h,f,b,
c,d)}},z={bridgeTimeout:1E4,guid:p,Client:E,Peer:F,EventEmitter:L,protocol:"se-0",urls:{"public":(M?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/public_bridge.html",local:"javascript:'<script src=\""+(M?"http:":"")+"//rawgit.com/bemson/subetha-bridge/master/subetha-bridge.min.js\">\x3c/script>'"},msgType:{}};u["::drop"]=1;u["::join"]=1;u["::readyStateChange"]=1;u["::connect"]=1;u["::disconnect"]=1;m.style.display="none";m.setAttribute("aria-hidden","true");m.setAttribute("hidden","hidden");
m.setAttribute("data-owner","subetha");B(L.prototype,{on:function(a,b){q(a)&&"function"===typeof b&&(k.call(this,"_evts")||(this._evts={}),k.call(this._evts,a)||(this._evts[a]=[]),this._evts[a].push(b));return this},off:function(a,b){var c,d,e=arguments.length;if(!k.call(this,"_evts")||!e)this._evts={};else if(q(a)&&k.call(this._evts,a)){c=this._evts[a];if("function"==typeof b)for(d=c.length;d--;)if(c[d]===b){c.splice(d,1);break}(2>e||!c.length)&&delete this._evts[a]}return this},fire:function(a){var b=
this,c,d,e,h,f;if(q(a)&&k.call(b,"_evts")&&k.call(b._evts,a)&&(e=(d=b._evts[a]).length))for(c=aa.call(arguments,1),f=c.length?function(a){a.apply(b,c)}:function(a){a.call(b)},h=0;h<e;h++)f(d[h]);return b}});B(V.prototype,{failures:0,state:1,cnt:0,addClient:function(a){var b=this,c=b.clients,d=a.id;k.call(c,d)||(b.cnt++,a._bridge=function(a){return a===K&&b},c[d]=a);3==b.state&&b.auth(a)},removeClient:function(a){var b=a.id,c=a.channel;--this.cnt?(delete this.clients[b],1<a.state&&(delete this.channels[c][b],
1==this.channelCnts[c]--&&delete this.channelCnts[c]),this.drop(a)):this.destroy()},auth:function(a){var b;t(a,2);2==a.state&&(b=a.credentials,I(b)||(b=[b]),this.send("auth",{id:a.id,channel:a.channel,creds:b}))},destroy:function(){var a=this.state,b=this.iframe,c=this.clients,d;this.dDay();this.state=4;this.clients={};this.cnt=0;for(d in c)k.call(c,d)&&this.drop(c[d]);this.cnt?this.state=a:(this.deref(),x(b,"load",this.onLoad),--Z||(x(f,"message",R),x(f,"unload",H),H()),m.contains(b)&&m.removeChild(b))},
deref:function(){delete r[this.id]},drop:function(a){var b=a.state;delete a._bridge;1<b&&4>b&&(this.send("drop",a.id),3==b&&t(a,4));a.peers={};4==a.state&&t(a,0)},decode:function(a){var b=this.cipher,c;if(q(a)&&(c=b.decode(a))&&(c=ia.exec(c)))try{return c=T(c[1]),b.shift++,c}catch(d){}3===++this.failures&&this.destroy();return 0},inDom:function(){var a=this.iframe;return m.contains(a)&&v.contains(a)},dDay:function(a){var b=this;clearTimeout(b.timer);a&&(b.timer=setTimeout(function(){b.destroy()},
a))},send:function(a,b){var c;if(3!=this.state)return 0;c=p();ka(this.iframe.contentWindow,{key:Y,mid:c,type:a,msg:b});return c}});E.prototype=new L;B(E.prototype,{id:"",channel:"lobby",url:"local",state:0,_bridge:function(){return!1},open:function(a){var b=this.channel,c=this.url,d=arguments,e=this.state,h;q(a)&&(h=a.indexOf("@"),~h?(b=a.substring(0,h)||b,c=a.substring(h+1)||c):b=a,1<d.length&&(this.credentials=aa.call(d,1)));ha.test(c)&&(c=ja+c);if(2<e){if(b==this.channel&&c==this.url)return;this.close();
e=this.state}this.channel=b;this.url=c;2>e&&(this.id=p(),t(this,1),1==this.state&&J(this));return this},close:function(){var a=this.state;0<a&&4>a&&W(this);return this},_transmit:function(a,b,c){var d=this._bridge(K),e;if((e=d&&3==d.state&&3==this.state&&q(a)&&!k.call(u,a))&&!(e=!b)){a:{e=this.peers;var h=[],f,g;I(b)||(b=[b]);for(g=b.length;g--;){f=b[g];f instanceof Subetha.Peer&&(f=f.id);if(!k.call(e,f)){e=0;break a}h.push(f)}e=h}e=b=e}return e?d.send("client",{type:a,from:this.id,to:b?[].concat(b):
0,data:c}):!1}});B(F.prototype,{state:3});"function"!==typeof f.postMessage?E.prototype.open=function(){return this}:D.body?w():(y(f,"DOMContentLoaded",w),y(f,"load",w));return z}N?define(p):O?module.exports=p():f.Subetha||(f.Subetha=p())}("function"===typeof define,"undefined"!=typeof exports,Array,Date,Math,JSON,Object,RegExp,this);